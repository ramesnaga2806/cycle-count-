<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Cycle Count</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, updateDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDBWFj82I9Rt1ZJygVZZahIdOOoETYteCc",
      authDomain: "cycle-count-a5f0d.firebaseapp.com",
      projectId: "cycle-count-a5f0d",
      storageBucket: "cycle-count-a5f0d.appspot.com",
      messagingSenderId: "986508290354",
      appId: "1:986508290354:web:d6cbd6e797cdbbb0968f2b",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let data = [];
    let currentIndex = 0;
    let showSystem = true;
    let supervisorMode = false;
    const todayStr = new Date().toISOString().split("T")[0];

    // -----------------------------
    // Firestore live listener
    // -----------------------------
    function setupLiveListener() {
      const q = query(collection(db, "cycle_counts"), where("date", "==", todayStr));
      onSnapshot(q, snapshot => {
        data = [];
        snapshot.forEach(docSnap => {
          const d = docSnap.data();
          d.id = docSnap.id;
          data.push(d);
        });
        renderCurrent();
        fetchDates();
      });
    }

    function toDateString(value) {
      try {
        if (!value) return "";
        if (value.toDate && typeof value.toDate === "function") return value.toDate().toISOString().split("T")[0];
        return String(value);
      } catch { return String(value); }
    }

    async function fetchDates() {
      try {
        const snapshot = await getDocs(collection(db, "cycle_counts"));
        const dates = new Set();
        snapshot.forEach(docSnap => {
          const ds = toDateString(docSnap.data().date);
          if (ds) dates.add(ds);
        });
        const list = document.getElementById("datesList");
        list.innerHTML = "";
        [...dates].sort().forEach(date => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.textContent = date;
          if (supervisorMode) {
            const btn = document.createElement("button");
            btn.className = "btn btn-sm btn-danger ms-2";
            btn.textContent = "Clear";
            btn.onclick = () => handleClearDate(date);
            li.appendChild(btn);
          }
          list.appendChild(li);
        });
      } catch (err) { console.error(err); }
    }

    async function readExcel(file) {
      document.getElementById("fileName").textContent = "Selected File: " + file.name;
      const reader = new FileReader();
      reader.onload = async (evt) => {
        try {
          const wb = XLSX.read(evt.target.result, { type: "array" });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, {
            header: ["location", "sku", "system_quantity"],
            range: 1,
          }).filter(r => r.location || r.sku);

          for (const entry of rows) {
            await addDoc(collection(db, "cycle_counts"), {
              date: todayStr,
              location: entry.location || "",
              sku: entry.sku || "",
              system_quantity: parseInt(entry.system_quantity) || 0,
              physical_quantity: null,
              variance: null
            });
          }
          alert("File uploaded and records added.");
        } catch (err) {
          console.error(err);
          alert("Error reading Excel.");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    async function uploadFile(file) {
      try {
        const storageRef = ref(storage, "uploads/" + file.name);
        await uploadBytes(storageRef, file);
        console.log("File uploaded to Storage");
      } catch (e) { console.warn("Storage upload failed:", e); }
      readExcel(file);
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("fileUpload")?.addEventListener("change", e => {
        const file = e.target.files[0];
        if (file) uploadFile(file);
      });
      document.getElementById("folderUpload")?.addEventListener("change", e => {
        const files = Array.from(e.target.files || []);
        const excelFiles = files.filter(f => f.name && (f.name.endsWith(".xlsx") || f.name.endsWith(".xls")));
        if (excelFiles.length > 0) uploadFile(excelFiles[0]);
      });
    });

    async function handleSubmit() {
      if (!data[currentIndex]) return alert("No item to submit.");
      const entry = data[currentIndex];
      const inputEl = document.getElementById("physicalQty");
      const physicalQty = parseInt(inputEl.value);
      if (isNaN(physicalQty)) return alert("Enter valid physical quantity.");

      try {
        const docRef = doc(db, "cycle_counts", entry.id);
        await updateDoc(docRef, {
          physical_quantity: physicalQty,
          variance: physicalQty - (parseInt(entry.system_quantity) || 0)
        });
        currentIndex++;
        inputEl.value = "";
        renderCurrent();
      } catch (err) { console.error(err); alert("Error updating record."); }
    }

    async function handleClearDate(dateStr) {
      if (!confirm(`Clear all records for ${dateStr}?`)) return;
      try {
        const q = query(collection(db, "cycle_counts"), where("date", "==", dateStr));
        const snapshot = await getDocs(q);
        await Promise.all(snapshot.docs.map(d => deleteDoc(doc(db, "cycle_counts", d.id))));
        alert(`Cleared data for ${dateStr}`);
      } catch (err) { console.error(err); }
    }

    async function clearAllData() {
      if (!confirm("⚠️ Delete ALL data?")) return;
      try {
        const snapshot = await getDocs(collection(db, "cycle_counts"));
        await Promise.all(snapshot.docs.map(d => deleteDoc(doc(db, "cycle_counts", d.id))));
        alert("All data cleared");
      } catch (err) { console.error(err); }
    }

    async function downloadAllData() {
      try {
        const snapshot = await getDocs(collection(db, "cycle_counts"));
        const rows = snapshot.docs.map(d => {
          const dd = d.data();
          return {
            date: toDateString(dd.date),
            location: dd.location ?? "",
            sku: dd.sku ?? "",
            system_quantity: dd.system_quantity ?? "",
            physical_quantity: dd.physical_quantity ?? "",
            variance: dd.variance ?? ""
          };
        });
        if (!rows.length) return alert("No data to download");

        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "CycleCounts");
        XLSX.writeFile(wb, `cycle_counts_all_${todayStr}.xlsx`);
      } catch (err) { console.error(err); alert("Download error."); }
    }

    function requestSupervisor() {
      const userId = prompt("User ID:");
      const pass = prompt("Password:");
      if (userId === "Invceva" && pass === "Ceva4567") {
        supervisorMode = true;
        document.getElementById("supervisorControls").classList.remove("d-none");
        alert("Supervisor access granted");
      } else alert("Invalid credentials");
    }

    function setSystemDisplay(val) {
      showSystem = !!val;
      renderCurrent();
    }

    function renderCurrent() {
      const container = document.getElementById("currentItem");
      container.innerHTML = "";
      if (!data || currentIndex >= data.length) {
        container.innerHTML = "<p class='text-success fw-bold'>✅ No items available.</p>";
        return;
      }
      const entry = data[currentIndex];
      let html = `
        <h4 class="text-success">Current Item</h4>
        <p><strong>Date:</strong> ${todayStr}</p>
        <p><strong>Location:</strong> ${entry.location}</p>
        <p><strong>SKU:</strong> ${entry.sku}</p>
      `;
      if (showSystem) {
        html += `<p><strong>System Qty:</strong> ${entry.system_quantity ?? 0}</p>
                 <p><strong>Variance:</strong> <span id="variance">${entry.variance ?? "-"}</span></p>`;
      }
      html += `
        <input type="number" id="physicalQty" class="form-control mt-2" placeholder="Enter Physical Quantity">
        <button class="btn btn-primary mt-3" id="submitBtn">Submit & Next</button>
      `;
      container.innerHTML = html;

      document.getElementById("submitBtn").addEventListener("click", handleSubmit);

      if (showSystem) {
        const qtyInput = document.getElementById("physicalQty");
        qtyInput.addEventListener("input", () => {
          const val = parseInt(qtyInput.value);
          const varianceEl = document.getElementById("variance");
          if (!isNaN(val)) {
            const v = val - (parseInt(entry.system_quantity) || 0);
            varianceEl.textContent = v;
            varianceEl.style.color = v < 0 ? "red" : "green";
          } else {
            varianceEl.textContent = "-";
            varianceEl.style.color = "black";
          }
        });
      }
    }

    window.requestSupervisor = requestSupervisor;
    window.setSystemDisplay = setSystemDisplay;
    window.clearAllData = clearAllData;
    window.downloadAllData = downloadAllData;
    window.handleSubmit = handleSubmit;

    // -----------------------------
    // Initialize
    // -----------------------------
    fetchDates();
    setupLiveListener();

  </script>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h2 class="text-center text-primary border-bottom border-3 border-primary pb-2 mb-4">
      Inventory Cycle Count
    </h2>

    <div class="card border-secondary mb-4">
      <div class="card-body">
        <label class="form-label fw-bold">Upload Excel File:</label>
        <input type="file" id="fileUpload" class="form-control" accept=".xlsx,.xls">
        <label class="form-label fw-bold mt-3">Upload Folder (Computer only):</label>
        <input type="file" id="folderUpload" class="form-control" webkitdirectory directory multiple>
        <p id="fileName" class="mt-2 text-muted"></p>
      </div>
    </div>

    <div id="currentItem" class="card border-success mb-4 p-3">
      <p class="text-muted">Upload a file to start counting.</p>
    </div>

    <div class="card border-dark mb-4 p-3">
      <h5>Supervisor Options</h5>
      <button class="btn btn-secondary" onclick="requestSupervisor()">🔑 Login as Supervisor</button>
      <div id="supervisorControls" class="mt-3 d-none">
        <button class="btn btn-warning me-2" onclick="setSystemDisplay(false)">Without System Qty</button>
        <button class="btn btn-success me-2" onclick="setSystemDisplay(true)">With System Qty</button>
        <button class="btn btn-danger me-2" onclick="clearAllData()">All Clear</button>
        <button class="btn btn-info" onclick="downloadAllData()">⬇️ Download All Data</button>
      </div>
    </div>

    <div class="card border-info p-3">
      <h5>Available Dates</h5>
      <ul id="datesList" class="list-group mt-2"></ul>
    </div>
  </div>
</body>
</html>
